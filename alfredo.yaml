---
apiVersion: v1
kind: Namespace
metadata:
  name: alfredo
---
apiVersion: v1
stringData:
  config.env: |
    export MINIO_BROWSER="on"
    export MINIO_STORAGE_CLASS_STANDARD="EC:1"
    export MINIO_ROOT_USER="hiddenlayerco"
    export MINIO_ROOT_PASSWORD="hiddenlayerco!0507"
# immutable: false
kind: Secret
metadata:
  labels:
    v1.min.io/tenant: object-storage
  name: object-storage-env-configuration
  namespace: alfredo
type: Opaque
---
apiVersion: v1
data:
  accesskey: ""
  secretkey: ""
# immutable: true
kind: Secret
metadata:
  labels:
    v1.min.io/tenant: object-storage
  name: object-storage-secret
  namespace: alfredo
type: Opaque
---
apiVersion: v1
data:
  CONSOLE_ACCESS_KEY: aGlkZGVubGF5ZXJjbwo=
  CONSOLE_SECRET_KEY: aGlkZGVubGF5ZXJjbyEwNTA3Cg==
# immutable: true
kind: Secret
metadata:
  labels:
    dash.ulagbulag.io/namespace: alfredo
  name: object-storage-user-0
  namespace: alfredo
type: Opaque
---
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  labels:
    v1.min.io/tenant: object-storage
  name: object-storage
  namespace: alfredo
spec:
  configuration:
    name: object-storage-env-configuration
  credsSecret:
    name: object-storage-secret
  # exposeServices:
  #   console: true
  #   minio: true
  image: minio/minio:RELEASE.2023-06-09T07-32-12Z
  imagePullSecret: {}
  mountPath: /export
  pools:
    - affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/kiss-ephemeral-control-plane
                    operator: DoesNotExist
              weight: 1
            - preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/kiss
                    operator: In
                    values:
                      - Compute
              weight: 2
            - preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/kiss
                    operator: In
                    values:
                      - Gateway
              weight: 4
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role.kubernetes.io/kiss
                    operator: In
                    values:
                      - Compute
                      - ControlPlane
                      - Gateway
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: v1.min.io/tenant
                    operator: In
                    values:
                      - object-storage
                  - key: v1.min.io/pool
                    operator: In
                    values:
                      - pool-0
              topologyKey: kubernetes.io/hostname
      name: pool-0
      resources:
        requests:
          cpu: "16"
          memory: 31Gi
      runtimeClassName: ""
      servers: 1
      volumeClaimTemplate:
        metadata:
          labels:
            v1.min.io/tenant: object-storage
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: "274877906944"
          storageClassName: ceph-block
      volumesPerServer: 4
  requestAutoCert: false
  # serviceMetadata:
  #   consoleServiceAnnotations:
  #     external-dns.alpha.kubernetes.io/hostname: minio-console.alfredo.mobilex.kr
  #     metallb.universe.tf/loadBalancerIPs: 210.125.85.50
  #   minioServiceAnnotations:
  #     external-dns.alpha.kubernetes.io/hostname: minio.alfredo.mobilex.kr
  #     metallb.universe.tf/loadBalancerIPs: 210.125.85.51
  users:
    - name: object-storage-user-0
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: alfredo.mobilex.kr
spec:
  acme:
    preferredChain: ""
    privateKeySecretRef:
      name: alfredo.mobilex.kr-cluster-issuer
    server: https://acme-v02.api.letsencrypt.org/directory
    solvers:
      - http01:
          ingress:
            class: alfredo.mobilex.kr
      - http01:
          ingress:
            class: minio.alfredo.mobilex.kr
      - http01:
          ingress:
            class: minio-console.alfredo.mobilex.kr
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minio
  namespace: alfredo
  annotations:
    cert-manager.io/cluster-issuer: alfredo.mobilex.kr
    ingress.kubernetes.io/ssl-redirect: "true"
    ingress.kubernetes.io/secure-backends: "true"
    ingress.kubernetes.io/force-ssl-redirect: "true"
    kubernetes.io/ingress.class: alfredo.mobilex.kr
    nginx.ingress.kubernetes.io/proxy-body-size: 200M
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    vine.ulagbulag.io/is-service: "true"
    vine.ulagbulag.io/is-service-public: "true"
    vine.ulagbulag.io/is-service-system: "false"
    vine.ulagbulag.io/service-kind: Alfredo Web Services - MinIO
spec:
  tls:
    - secretName: minio.alfredo.mobilex.kr
      hosts:
        - minio.alfredo.mobilex.kr
  rules:
    - host: minio.alfredo.mobilex.kr
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: minio
                port:
                  number: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: object-storage-console
  namespace: alfredo
  annotations:
    cert-manager.io/cluster-issuer: alfredo.mobilex.kr
    ingress.kubernetes.io/ssl-redirect: "true"
    ingress.kubernetes.io/secure-backends: "true"
    ingress.kubernetes.io/force-ssl-redirect: "true"
    kubernetes.io/ingress.class: alfredo.mobilex.kr
    nginx.ingress.kubernetes.io/proxy-body-size: 200M
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    vine.ulagbulag.io/is-service: "true"
    vine.ulagbulag.io/is-service-public: "true"
    vine.ulagbulag.io/is-service-system: "false"
    vine.ulagbulag.io/service-kind: Alfredo Web Services - MinIO Console
spec:
  tls:
    - secretName: minio-console.alfredo.mobilex.kr
      hosts:
        - minio-console.alfredo.mobilex.kr
  rules:
    - host: minio-console.alfredo.mobilex.kr
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: object-storage-console
                port:
                  number: 9090
---
apiVersion: v1
kind: Service
metadata:
  name: web-dev
  namespace: alfredo
spec:
  type: ExternalName
  externalName: ai-dev-561c6eed-7319-4baf-ab4d-291647789d55.dash-ai.svc.ops.openark
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 8080
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: alfredo.mobilex.kr
spec:
  acme:
    preferredChain: ""
    privateKeySecretRef:
      name: alfredo.mobilex.kr-cluster-issuer
    server: https://acme-v02.api.letsencrypt.org/directory
    solvers:
      - http01:
          ingress:
            class: alfredo.mobilex.kr
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web-dev
  namespace: alfredo
  annotations:
    cert-manager.io/cluster-issuer: alfredo.mobilex.kr
    ingress.kubernetes.io/ssl-redirect: "true"
    ingress.kubernetes.io/secure-backends: "true"
    ingress.kubernetes.io/force-ssl-redirect: "true"
    kubernetes.io/ingress.class: alfredo.mobilex.kr
    nginx.ingress.kubernetes.io/proxy-body-size: 200M
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    vine.ulagbulag.io/is-service: "true"
    vine.ulagbulag.io/is-service-public: "true"
    vine.ulagbulag.io/is-service-system: "false"
    vine.ulagbulag.io/service-kind: Alfredo Web Services - Dev
spec:
  tls:
    - secretName: alfredo.mobilex.kr
      hosts:
        - alfredo.mobilex.kr
  rules:
    - host: alfredo.mobilex.kr
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web-dev
                port:
                  number: 80
