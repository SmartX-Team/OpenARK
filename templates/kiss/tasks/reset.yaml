---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-task-reset
  namespace: kiss
data:
  main.yaml: |
    ---
    - import_playbook: remove-node.yaml
    - hosts: localhost
      tasks:
        - include_tasks: reboot-node.yaml
  remove-node.yaml: |
    ---
    - import_playbook: >
        /kubespray/remove-node.yml
        allow_ungraceful_removal="true"
        node="target"
        reset_nodes="false"
        skip_confirmation="true"
  reboot-node.yaml: |
    ---
    - name: Change boot order to PXE-first
      when: ansible_ipmi_host is defined and ansible_ipmi_host != ""
      ipmi_boot:
        name: "{{ ansible_ipmi_host }}"
        user: kiss
        password: "{{ ansible_ipmi_password }}"
        bootdev: pxe
        persistent: true
      ignore_errors: true

    - name: Reset node's power
      when: ansible_ipmi_host is defined and ansible_ipmi_host != ""
      ipmi_power:
        name: "{{ ansible_ipmi_host }}"
        user: kiss
        password: "{{ ansible_ipmi_password }}"
        state: reset
      ignore_errors: true
