---
- name: Populate service facts
  service_facts:

- name: Check whether kubelet is running
  assert:
    that: ansible_facts.services["kubelet.service"].state == "running"

- name: Check whether kubernetes entrypoint is running
  uri:
    url: https://localhost:6443/livez?verbose
    method: GET
    ca_path: /etc/kubernetes/ssl/ca.crt
    client_cert: /var/lib/kubelet/pki/kubelet-client-current.pem
    client_key: /var/lib/kubelet/pki/kubelet-client-current.pem
  register: result
  until: result.status == 200
  retries: 5
  delay: 2

- name: Check whether kubernetes node is working
  uri:
    url: https://localhost:6443/api/v1/nodes/{{ ansible_host_uuid }}
    method: GET
    ca_path: /etc/kubernetes/ssl/ca.crt
    client_cert: /var/lib/kubelet/pki/kubelet-client-current.pem
    client_key: /var/lib/kubelet/pki/kubelet-client-current.pem
  register: result
  until: result.status == 200
  retries: 5
  delay: 2
