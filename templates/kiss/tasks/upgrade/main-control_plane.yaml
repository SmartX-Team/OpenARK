---
- hosts: kube_control_plane
  tasks:
    - name: Remove legacy APIServices
      command: >
        {{ bin_dir }}/kubectl delete APIServices v1beta1.metrics.k8s.io
      ignore_errors: true

- name: Upgrade cluster
  import_playbook: >
    /kubespray/upgrade-cluster.yml
    etcd_retries="10"

- hosts: kube_control_plane
  tasks:
    - name: Update Resource Limits - kube-apiserver
      shell: >
        cat /etc/kubernetes/manifests/kube-apiserver.yaml
        | grep -Po '^ +memory:' >/dev/null 2>/dev/null
        || sed -i
        's/^\( \+\)  \(cpu\:.\+\)$/\1  \2\n\1  memory: 256Mi\n\1limits:\n\1  cpu: "4"\n\1  memory: 4Gi/g'
        /etc/kubernetes/manifests/kube-apiserver.yaml
