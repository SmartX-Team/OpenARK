---
- hosts: localhost
  gather_facts: false
  tasks:
    - name: Set common facts
      set_fact:
        ansible_host_id: "{{ lookup('env', 'ansible_host_id') }}"
        box_state_completed: "{{ lookup('env', 'box_state_completed') }}"

    - name: Add control planes
      loop: "{{ lookup('env', 'kiss_cluster_control_planes') | split(' ') }}"
      loop_control:
        loop_var: node_packed
      when: node_packed | length
      include: ./add-control_planes.yaml

    - name: Add etcd nodes
      loop: "{{ lookup('env', 'kiss_cluster_etcd_nodes') | split(' ') }}"
      loop_control:
        loop_var: node_packed
      when: node_packed | length
      include: ./add-control_planes.yaml

    - name: Add workers
      add_host:
        ansible_host: "{{ lookup('env', 'ansible_host') }}"
        ansible_host_id: "{{ lookup('env', 'ansible_host_id') }}"
        ansible_host_uuid: "{{ lookup('env', 'ansible_host_uuid') }}"
        ansible_host_key_checking: false
        ansible_ssh_host: "{{ lookup('env', 'ansible_ssh_host') }}"
        ansible_ssh_private_key_file: "{{ lookup('env', 'ansible_ssh_private_key_file') }}"
        ansible_ssh_user: "{{ lookup('env', 'ansible_user') }}"
        ansible_user: "{{ lookup('env', 'ansible_user') }}"
        ansible_ipmi_host: "{{ lookup('env', 'ansible_ipmi_host') }}"
        ansible_ipmi_username: "{{ lookup('env', 'ansible_ipmi_username') }}"
        ansible_ipmi_password: "{{ lookup('env', 'ansible_ipmi_password') }}"
        kiss_allow_critical_commands: "{{ lookup('env', 'kiss_allow_critical_commands') == 'true' }}"
        kiss_allow_pruning_network_interfaces: "{{ lookup('env', 'kiss_allow_pruning_network_interfaces') == 'true' }}"
        kiss_group_force_reset: "{{ lookup('env', 'kiss_group_force_reset') == 'true' }}"
        kiss_group_role: "{{ lookup('env', 'kiss_group_role') }}"
        kiss_network_interface_mtu_size: "{{ lookup('env', 'kiss_network_interface_mtu_size') }}"
        kiss_network_ipv4_dhcp_duration: "{{ lookup('env', 'kiss_network_ipv4_dhcp_duration') }}"
        kiss_network_ipv4_dhcp_range_begin: "{{ lookup('env', 'kiss_network_ipv4_dhcp_range_begin') }}"
        kiss_network_ipv4_dhcp_range_end: "{{ lookup('env', 'kiss_network_ipv4_dhcp_range_end') }}"
        kiss_network_ipv4_gateway: "{{ lookup('env', 'kiss_network_ipv4_gateway') }}"
        kiss_network_ipv4_subnet: "{{ lookup('env', 'kiss_network_ipv4_subnet') }}"
        kiss_network_ipv4_subnet_address: "{{ lookup('env', 'kiss_network_ipv4_subnet_address') }}"
        kiss_network_ipv4_subnet_mask: "{{ lookup('env', 'kiss_network_ipv4_subnet_mask') }}"
        kiss_network_ipv4_subnet_mask_prefix: "{{ lookup('env', 'kiss_network_ipv4_subnet_mask_prefix') }}"
        kiss_network_nameserver_incluster_ipv4: "{{ lookup('env', 'kiss_network_nameserver_incluster_ipv4') }}"
        name: "{{ lookup('env', 'ansible_host') }}"
        groups:
          - all
          - flatcar
          - kube_node
          - target

    - name: Bind to group - Control Plane
      when:
        - lookup('env', 'kiss_group_role') == 'ControlPlane'
      add_host:
        name: "{{ lookup('env', 'ansible_host') }}"
        groups: kube_control_plane

    - name: Bind to group - ETCD
      when:
        - lookup('env', 'kiss_group_role') == 'ControlPlane'
        - groups['etcd'] | length % 2 == 0 # etcd nodes should be odd
      add_host:
        name: "{{ lookup('env', 'ansible_host') }}"
        groups: etcd

- hosts: all
  gather_facts: false
  tasks:
    - name: Change cluster name - {{ lookup('env', 'kiss_cluster_name') }}
      set_fact:
        cluster_name: "ops.{{ lookup('env', 'kiss_cluster_domain') }}"
        coredns_k8s_external_zone: "k8s.{{ lookup('env', 'kiss_cluster_domain') }}"
        kiss_cluster_name: "{{ lookup('env', 'kiss_cluster_name') }}"
        kiss_cluster_is_default: "{{ lookup('env', 'kiss_cluster_is_default') == 'true' }}"

- hosts: flatcar
  gather_facts: false
  tasks:
    - name: Set common facts
      set_fact:
        ansible_python_interpreter: /opt/bin/python
        bin_dir: /opt/bin
