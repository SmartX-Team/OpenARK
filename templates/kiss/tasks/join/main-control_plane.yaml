---
- import_playbook: ./add-node-as-control_plane.yaml
- import_playbook: ./add-node-as-bgp-peer.yaml

# TODO: manage by root cluster
- hosts: kube_control_plane
  tasks:
    - when:
        - groups['kube_control_plane'] | length == 1
        - kiss_cluster_is_default is defined and not kiss_cluster_is_default
      block:
        - name: Mark the bootstrapped node as "first-node"
          shell: >
            {{ bin_dir }}/kubectl label nodes {{ inventory_hostname }}
            --overwrite
            node-role.kubernetes.io/first-node=

        - name: Create Kiss Namespace
          shell: >
            {{ bin_dir }}/kubectl get namespace kiss
            || {{ bin_dir }}/kubectl create namespace kiss

        - name: Inherit ConfigMap - baremetal-config
          block:
            - name: Download ConfigMap
              delegate_to: localhost
              shell:
                cmd: >
                  kubectl get -n kiss configmap "baremetal-config" -o yaml
              register: result

            - name: Save ConfigMap
              shell:
                cmd: >
                  {{ bin_dir }}/kubectl get -n kiss configmap "baremetal-config"
                  || {{ bin_dir }}/kubectl create -f -
                stdin: "{{ result.stdout }}"

        - name: Get CSI Information
          shell: >
            {{ bin_dir }}/kubectl get -n kiss configmap "baremetal-config"
            -o jsonpath --template '{.data.csi}'
          register: result_csi

        - name: Install CSI
          when: result_csi.stdout != "none"
          shell: >
            ctr containers delete "kiss-csi-installer-{{ result_csi.stdout }}"
            ; ctr images pull
            "quay.io/ulagbulag-village/netai-cloud-upgrade-csi-{{ result_csi.stdout }}:latest"
            && ctr run --detach --rm
            --net-host
            --mount type=bind,src=/root/.kube,dst=/root/.kube,options=rbind:ro
            "quay.io/ulagbulag-village/netai-cloud-upgrade-csi-{{ result_csi.stdout }}:latest"
            "kiss-csi-installer-{{ result_csi.stdout }}"

        - name: Install GPU Operator | {{ item }}
          loop:
            - nvidia
          shell: >
            ctr containers delete "kiss-gpu-installer-{{ item }}"
            ; ctr images pull
            "quay.io/ulagbulag-village/netai-cloud-upgrade-gpu-{{ item }}:latest"
            && ctr run --detach --rm
            --net-host
            --mount type=bind,src=/root/.kube,dst=/root/.kube,options=rbind:ro
            "quay.io/ulagbulag-village/netai-cloud-upgrade-gpu-{{ item }}:latest"
            "kiss-gpu-installer-{{ item }}"

        - name: Install IPIS
          shell: >
            ctr containers delete "kiss-ipis-installer"
            ; ctr images pull
            "quay.io/ulagbulag-village/netai-cloud-upgrade-ipis:latest"
            && ctr run --detach --rm
            --net-host
            --mount "type=bind,src=/root/.kube,dst=/root/.kube,options=rbind:ro"
            "quay.io/ulagbulag-village/netai-cloud-upgrade-ipis:latest"
            "kiss-ipis-installer"
