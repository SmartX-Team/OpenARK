---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-task-commission
  namespace: kiss
data:
  main.yaml: |
    ---
    - hosts: target
      tasks:
        - include_tasks: hostname.yaml
        - include_tasks: power.yaml
        - include_tasks: network.yaml
        # - include_tasks: storage.yaml
        - include_tasks: submit.yaml
  hostname.yaml: |
    ---
    - name: Set machine hostname
      shell: >
        hostnamectl set-hostname '{{ ansible_host }}'
  power.yaml: |
    ---
    - name: Check whether IPMI exists
      stat:
        path: /dev/ipmi0
      register: ipmi

    - name: Pull IPMI docker image
      when: ipmi.stat.exists
      shell: >
        docker pull
        docker.io/mikeynap/ipmitool:latest
      retries: 5
      delay: 5

    - name: Get IPMI IP Address
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        lan print
        | sed -n -e 's/^IP Address *: *\([0-9.]*\)/\1/p'
      register: ipmi_address

    - name: Set IPMI IP Address
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        lan set 1 ipaddr "{{ ipmi_address.stdout }}"
      ignore_errors: true

    - name: Set IPMI IP Address Netmask
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        lan set 1 netmask 255.240.0.0
      ignore_errors: true

    - name: Set IPMI IP Address Default Gateway
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        lan set 1 defgw ipaddr 10.47.255.254
      ignore_errors: true

    - name: Set IPMI user 9 name
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        user set name 9 'kiss'
      ignore_errors: true

    - name: Set IPMI user 9 password
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        user set password 9 'kiss.netaiCloud'
      ignore_errors: true

    - name: Enable IPMI user 9
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        user enable 9

    - name: Link on IPMI user 9 as ADMIN
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        channel setaccess 1 9 callin=on ipmi=on link=on privilege=4

    - name: Change boot order to PXE-first
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        chassis bootparam set bootflag force_pxe

    - name: Change boot order to PXE-first
      when: ipmi.stat.exists
      shell: >
        docker run --rm
        --device /dev/ipmi0:/dev/ipmi0:rw
        docker.io/mikeynap/ipmitool:latest
        chassis bootdev pxe
      ignore_errors: true
  network.yaml: |
    ---
    - name: Get Network Interfaces
      shell: ls /sys/class/net | grep -e '^en*'
      register: netdev

    - name: Get Network Interfaces
      debug:
        msg: "{{ netdev.stdout_lines }}"
  storage.yaml: |
    ---
    []
  submit.yaml: |
    ---
    - name: Submit results to kiss cluster
      uri:
        url: http://gateway.kiss.svc.ops.netai-cloud/commission
        method: POST
        return_content: false
        status_code: 200
        body_format: json
        body:
          access:
            address: "{{ ansible_ssh_host }}"
          machine:
            uuid: "{{ ansible_host_uuid }}"
          power:
            type: Ipmi
            address: "{{ ipmi_address.stdout }}"
