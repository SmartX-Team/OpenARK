---
- name: Provision Power Planes - IPMI Common
  include: power-ipmi-common.yaml

- name: Get IPMI IP Address
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    lan print
    | sed -n -e 's/^IP Address *: *\([0-9.]*\)/\1/p'
  register: ipmi_address

- name: Set IPMI IP Address be Static
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    lan set 1 ipsrc static
  ignore_errors: true

- name: Set IPMI IP Address
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    lan set 1 ipaddr '{{ ipmi_address.stdout }}'
  ignore_errors: true

- name: Set IPMI IP Address Netmask
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    lan set 1 netmask '{{ kiss_network_ipv4_subnet_mask }}'
  ignore_errors: true

- name: Set IPMI IP Address Default Gateway
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    lan set 1 defgw ipaddr '{{ kiss_network_ipv4_gateway }}'
  ignore_errors: true

- name: Set IPMI user 9 name
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    user set name 9 '{{ kiss_power_ipmi_username }}'
  ignore_errors: true
  no_log: true

- name: Set IPMI user 9 password
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    user set password 9 '{{ kiss_power_ipmi_password }}'
  ignore_errors: true
  no_log: true

- name: Enable IPMI user 9
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    user enable 9
  ignore_errors: true

- name: Link on IPMI user 9 as ADMIN
  when: ipmi.stat.exists
  shell: >
    ctr run --rm
    --device /dev/ipmi0
    "quay.io/ulagbulag-village/netai-cloud-ipmitool:latest"
    "kiss-ipmitool" ipmitool
    channel setaccess 1 9 callin=on ipmi=on link=on privilege=4
  ignore_errors: true
