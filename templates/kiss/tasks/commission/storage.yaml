---
- name: Check whether kiss storage is already configured
  set_fact:
    kiss_storage_exists: >-
      {{
        (not (kiss_group_force_reset | default(False)))
      and
        ('kiss' in ansible_lvm.vgs.keys())
      }}

- name: Cleanup disks
  when: not kiss_storage_exists
  include: storage-cleanup.yaml

- name: Provision disks
  when: not kiss_storage_exists
  include: storage-provision.yaml

- name: Provision logical volumes
  block:
    - name: Define volume informations
      set_fact:
        lvs:
          - kind: binary
            name: cni
            path: /opt/cni
            size: 8G
          - kind: binary
            name: common
            path: /opt/bin
            size: 1G
            overlay: true
          - kind: binary
            name: etcd
            path: /opt/etcd
            size: 8G
          - kind: binary
            name: pypy3
            path: /opt/pypy3
            size: 256M
            overlay: true
          - kind: etc
            name: cni
            path: /etc/cni
            size: 16M
          - kind: etc
            name: containerd
            path: /etc/containerd
            size: 16M
          - kind: etc
            name: etcd
            path: /etc/etcd
            size: 16M
          - kind: etc
            name: k8s
            path: /etc/kubernetes
            size: 16M
          - kind: etc
            name: overlay
            path: /etc
            size: 256M
            overlay: true
          - kind: home
            name: k8s
            path: /root/.kube
            size: 16M
          - kind: var
            name: calico
            path: /var/lib/calico
            size: 16M
          - kind: var
            name: cni
            path: /var/lib/cni
            size: 256M
          - kind: var
            name: containerd
            path: /var/lib/containerd
            size: 64G
          - kind: var
            name: k8s
            path: /var/lib/kubelet
            size: 256M
          - kind: var
            name: proxy_cache
            path: /var/lib/proxy_cache
            size: 16G
          - kind: var
            name: rook
            path: /var/lib/rook
            size: 64G
          - kind: var
            name: system.log
            path: /var/log
            size: 16G

    - name: Do Provision
      loop: "{{ lvs }}"
      loop_control:
        loop_var: lv
      include: storage-provision-volumes.yaml
