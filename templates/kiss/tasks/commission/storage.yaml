---
- name: Check whether kiss OS is installed in a disk
  block:
    - name: Check whether kiss OS is installed in a disk - Flatcar Container Linux
      when: kiss_os_default == 'flatcar'
      stat:
        path: /boot/flatcar
      register: boot_file
    - name: Check whether kiss OS is installed in a disk - RockyLinux
      when: kiss_os_default == 'rocky9'
      stat:
        path: /boot/efi/EFI/rocky
      register: boot_file

- name: Check whether kiss OS is dirty
  stat:
    path: /opt/.kiss-dirty
  register: kiss_dirty_file

- name: Check whether kiss OS is already configured
  set_fact:
    kiss_os_exists: "{{ boot_file.stat.exists }}"
    kiss_os_dirty: "{{ kiss_dirty_file.stat.exists }}"

- name: Collect brief device informations
  loop: "{{ ansible_devices.items() }}"
  # filter the devices that has 1 or more physical IDs
  when: >-
    (item[1].links.ids | length) > 0
    and item[1].sectors != '0'
    and item[1].scheduler_mode != ''
  set_fact:
    # TODO: sort names numerically
    devices: >
      {{ devices|default([]) + [{
        'name': item[0],
        'size': (item[1].sectors | int) * (item[1].sectorsize | int),
      }] }}

- name: Find the most suitable device (>=200Gi)
  set_fact:
    device: "{{ devices | selectattr('size', 'ge', 200 * 1024 * 1024 * 1024) | sort(attribute='size,name') | first }}"

- name: Check whether kiss storage is already configured
  # TODO: verify data
  set_fact:
    kiss_storage_exists: >-
      {{
        kiss_os_exists
      and
        (not (kiss_group_force_reset | default(False)))
      }}

- name: Update boot order to PxE-first
  when:
    - kiss_group_force_reset_os
    - kiss_os_exists
    - kiss_os_dirty
    - not kiss_storage_exists
  include: boot-pxe.yaml

- name: Reboot the boxes before re-installing OS (The task will be restarted)
  when:
    - kiss_group_force_reset_os
    - kiss_os_exists
    - kiss_os_dirty
    - not kiss_storage_exists
  reboot:
    reboot_timeout: 3600 # 1h (booting can take a long time)

- name: Assert rebooting
  when:
    - kiss_group_force_reset_os
    - kiss_os_exists
    - kiss_os_dirty
    - not kiss_storage_exists
  fail:
    msg: The nodes should be rebooted!

- name: Regard kiss OS as dirty
  when:
    - kiss_os_exists
    - not kiss_os_dirty
  file:
    path: /opt/.kiss-dirty
    state: touch
    mode: "0444"

- name: Cleanup disks
  when:
    - not kiss_os_exists or kiss_os_dirty
    - not kiss_storage_exists
  include: storage-cleanup.yaml

- name: Provision disks
  include: storage-provision.yaml

- name: Update boot order to Disk-first
  when:
    - not kiss_os_exists
    - kiss_os_hot_install
  include: boot-disk.yaml

- name: Update boot order to PxE-first
  when:
    - not kiss_os_exists
    - not kiss_os_hot_install
  include: boot-pxe.yaml

- name: Reboot the boxes after installing OS (The task will be restarted)
  when: not kiss_os_exists
  reboot:
    reboot_timeout: 3600 # 1h (booting can take a long time)

- name: Assert rebooting
  when: not kiss_os_exists
  fail:
    msg: The nodes should be rebooted!
