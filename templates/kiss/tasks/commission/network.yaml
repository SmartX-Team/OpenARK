---
- name: Populate service facts
  service_facts:

- name: Check whether systemd-networkd is running
  assert:
    that: ansible_facts.services["systemd-networkd.service"].state == "running"

- name: Collect network inteface infomations
  loop: "{{ ansible_interfaces }}"
  # filter the physical devices that has connected to the specific network as ethernet
  when: >
    item in ansible_facts
    and ansible_facts[item].active
    and ansible_facts[item].type == 'ether'
    and 'ipv4' in ansible_facts[item]
    and 'netmask' in ansible_facts[item].ipv4
    and ansible_facts[item].ipv4.netmask == '255.240.0.0'
    and 'network' in ansible_facts[item].ipv4
    and ansible_facts[item].ipv4.network == '10.32.0.0'
  set_fact:
    interfaces: >
      {{ interfaces|default([]) + [{
        'name': item,
        'address_ipv4': ansible_facts[item].ipv4.address,
        'address_ipv4_netmask': 12,
        'address_ipv4_gateway': ansible_default_ipv4.gateway,
        'dns': [
          '1.1.1.1',
        ],
        'macaddress': ansible_facts[item].macaddress,
        'module': ansible_facts[item].module,
        'pciid': ansible_facts[item].pciid,
        'speed': ansible_facts[item].speed,
        'speed_neg': -ansible_facts[item].speed,
      }] }}

- name: Sort by speed, module, and PCI ID
  set_fact:
    interfaces: "{{ interfaces | sort(attribute='speed_neg,module,pciid') }}"

- name: Select the fastest interface as Primary
  when: interfaces | length > 0
  set_fact:
    interface_primary: "{{ interfaces[0] }}"
    interface_primary_address_ipv4: "{{ interfaces[0].address_ipv4 }}"

- name: Ping from primary interface to the gateway
  when: interface_primary_address_ipv4 is defined
  command: >
    ping -4 -c 4
    -I {{ interface_primary_address_ipv4 }}
    {{ ansible_default_ipv4.gateway }}
  register: result
  until: result.rc == 0
  delay: 5
  retries: 5

- name: List all network configurations
  find:
    paths:
      - /etc/systemd/network/
    file_type: directory
    pattern: "*-kiss-*"
  register: results

- name: Remove all network configurations
  file:
    path: "{{ item.path }}"
    state: absent
    force: true
  with_items: "{{ results.files }}"

- name: Enable primary interfaces
  loop: "{{ interfaces[:1] }}"
  template:
    src: ./template_systemd-networkd_10-enable.link.j2
    dest: /etc/systemd/network/10-kiss-enable-{{ item.name }}.link

- name: Link up primary interfaces
  loop: "{{ interfaces[:1] }}"
  command: ip link set {{ item.name }} up

- name: Fix primary interface network
  loop: "{{ interfaces[:1] }}"
  template:
    src: ./template_systemd-networkd_11-enable.network.j2
    dest: /etc/systemd/network/11-kiss-enable-{{ item.name }}.network

- name: Fix primary interface network for now
  loop: "{{ interfaces[:1] }}"
  command: ip link set {{ item.name }} up

- name: Disable primary interface network by DHCP
  loop: "{{ interfaces[:1] }}"
  command: >
    ip link del default
    via {{ item.address_ipv4_gateway }}
    dev {{ item.name }}
    proto dhcp
  ignore_errors: true

- name: Update SSH access IP
  when: interface_primary is defined
  set_fact:
    ansible_ssh_host: "{{ interface_primary_address_ipv4 }}"

- name: Disable all other interfaces
  loop: "{{ interfaces[1:] }}"
  template:
    src: ./template_systemd-networkd_20-disable.link.j2
    dest: /etc/systemd/network/20-kiss-disable-{{ item.name }}.link

- name: Link down all other interfaces
  loop: "{{ interfaces[1:] }}"
  command: ip link set {{ item.name }} down

- name: Restart systemd-networkd
  when: interface_primary is defined
  systemd:
    name: systemd-networkd.service
    state: restarted
    daemon_reload: yes

- name: Show about the primary inteface
  when: interface_primary is defined
  debug:
    var: interface_primary
