---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dnsmasq-dhcp-range
  namespace: kiss
data:
  ipv4Begin: "10.32.0.0"
  ipv4End: "10.32.255.254"
  ipv4Gateway: "10.47.255.254"
  ipv4NameServer1: "10.112.0.3"
  ipv4Duration: "7d"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dnsmasq
  namespace: kiss
spec:
  replicas: 1
  strategy:
    rollingUpdate:
      maxUnavailable: 1
  selector:
    matchLabels:
      name: dnsmasq
  template:
    metadata:
      labels:
        name: dnsmasq
        serviceType: internal
    spec:
      hostNetwork: true
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: init-tftpboot
          image: docker.io/kerryeon/ipxe:latest
          command:
            - bash
          args:
            - -c
            - cp /ipxe/* /var/lib/tftpboot
          resources:
            requests:
              cpu: 30m
              memory: 20Mi
            limits:
              cpu: 50m
              memory: 50Mi
          volumeMounts:
            - name: tftpboot
              mountPath: /var/lib/tftpboot
      containers:
        - name: dnsmasq
          image: quay.io/poseidon/dnsmasq:latest
          args:
            - -d
            - --enable-tftp
            - --tftp-root=/var/lib/tftpboot
            - --dhcp-match=set:bios,option:client-arch,0
            - --dhcp-boot=tag:bios,undionly.kpxe
            # - --dhcp-match=set:efi-i386,option:client-arch,6
            # - --dhcp-boot=tag:efi-i386,ipxe-i386.efi
            - --dhcp-match=set:efi-bc,option:client-arch,7
            - --dhcp-boot=tag:efi-bc,ipxe-x86_64.efi
            - --dhcp-match=set:efi-x86_64,option:client-arch,9
            - --dhcp-boot=tag:efi-x86_64,ipxe-x86_64.efi
            - --dhcp-match=set:efi-arm64,option:client-arch,11
            - --dhcp-boot=tag:efi-arm64,ipxe-arm64.efi
            - --dhcp-userclass=set:ipxe,iPXE
            - --dhcp-boot=tag:ipxe,http://matchbox.kiss.svc.ops.netai-cloud/assets/boot/boot.ipxe
            - --dhcp-option=3,$(DHCP_RANGE_IPV4_GATEWAY)
            - --dhcp-option=6,$(DHCP_RANGE_IPV4_NAMESERVER_1)
            - --dhcp-range=$(DHCP_RANGE_IPV4_BEGIN),$(DHCP_RANGE_IPV4_END),$(DHCP_RANGE_IPV4_DURATION)
            - --port=0
            - --bind-dynamic
            - --log-queries
            - --log-dhcp
          env:
            - name: DHCP_RANGE_IPV4_BEGIN
              valueFrom:
                configMapKeyRef:
                  name: dnsmasq-dhcp-range
                  key: ipv4Begin
            - name: DHCP_RANGE_IPV4_END
              valueFrom:
                configMapKeyRef:
                  name: dnsmasq-dhcp-range
                  key: ipv4End
            - name: DHCP_RANGE_IPV4_GATEWAY
              valueFrom:
                configMapKeyRef:
                  name: dnsmasq-dhcp-range
                  key: ipv4Gateway
            - name: DHCP_RANGE_IPV4_NAMESERVER_1
              valueFrom:
                configMapKeyRef:
                  name: dnsmasq-dhcp-range
                  key: ipv4NameServer1
            - name: DHCP_RANGE_IPV4_DURATION
              valueFrom:
                configMapKeyRef:
                  name: dnsmasq-dhcp-range
                  key: ipv4Duration
          ports:
            - name: dhcp
              protocol: UDP
              containerPort: 67
          resources:
            requests:
              cpu: 30m
              memory: 20Mi
            limits:
              cpu: 50m
              memory: 50Mi
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
          volumeMounts:
            - name: tftpboot
              mountPath: /var/lib/tftpboot
      volumes:
        - name: tftpboot
          emptyDir: {}
