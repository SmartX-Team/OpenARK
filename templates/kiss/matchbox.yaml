---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matchbox-boot
  namespace: kiss
data:
  boot-flatcar.ipxe: |
    #!ipxe
    # Retry automatic configuration indefinitely until it succeeds
    :boot
    chain /ipxe?mac=${mac:hexhyp}&chip=${chip}&domain=${domain}&hostname=${hostname}&uuid=${uuid}&manufacturer=${manufacturer}&product=${product}&serial=${serial}&buildarch=${buildarch}&cpumodel=${cpumodel}&cpuvendor=${cpuvendor}&platform=${platform} || goto boot
  boot-rocky9.ipxe: >
    #!ipxe


    :kernel

    kernel http://assets.kiss.svc.ops.netai-cloud/rocky9/${buildarch}/kickstart/images/pxeboot/vmlinuz
    initrd=initrd.img
    inst.repo=http://assets.kiss.svc.ops.netai-cloud/rocky9/${buildarch}/kickstart/
    inst.ks=http://matchbox.kiss.svc.ops.netai-cloud/assets/boot/rocky9.ks
    || goto kernel


    :initrd

    initrd http://assets.kiss.svc.ops.netai-cloud/rocky9/${buildarch}/kickstart/images/pxeboot/initrd.img
    || goto initrd


    boot
  rocky9.ks: |
    # https://access.redhat.com/labs/kickstartconfig/

    # Install Method
    firstboot --disable
    text

    # Machine Information
    ## EULA Agreement
    eula --agreed
    ## Firewall configuration
    firewall --disabled
    ## Keyboard layouts
    keyboard us
    ## Network
    network --activate --bootproto=dhcp
    ## SELinux configuration
    selinux --permissive
    ## System authorization
    authselect --enablemkhomedir --enablesssd --enablesssdauth --updateall
    ## System language
    lang en_US.UTF-8
    ## System timezone
    timezone Asia/Seoul --utc

    # Install Packages
    %packages
    @^minimal-environment
    lvm2
    NetworkManager-wifi
    podman-docker
    yum-utils
    %end

    # KDump Configuration
    %addon com_redhat_kdump --enable --reserve-mb='auto'
    %end

    # User Configuration
    rootpw --lock
    group --name docker
    group --name users
    group --name wheel
    user --name ENV_USERNAME --groups docker,users,wheel
    sshkey --username ENV_USERNAME "ENV_SSH_AUTHORIZED_KEYS"

    # Disk Configuration
    clearpart --all --initlabel
    %include /tmp/kiss-config
    %pre

    # Minimum size of disk needed specified in GIBIBYTES
    MINSIZE=200

    BLOCKDEV="/sys/block"
    ROOTDEV=""
    ROOTSIZE=1000000000

    # /sys/block/*/size is in 512 byte chunks
    for DEV in $(lsblk -d | sed 's/^\(nvme[0-9]\+n[0-9]\+\)\?\(sd[a-z]\+\)\?.*$/\1\2/g' | xargs); do
      if [ -d $BLOCKDEV/$DEV ]; then
        if (( $(cat $BLOCKDEV/$DEV/removable) == 0 )); then
          # Remove all data in disks
          wipefs --all --force /dev/$DEV && sync
          sgdisk --zap-all /dev/$DEV && sync
          dd if=/dev/zero of=/dev/$DEV bs=1M count=1024 && sync
          partprobe /dev/$DEV && sync

          # Find the suitable disk
          SIZE=$(( $(cat $BLOCKDEV/$DEV/size)/2**21 ))
          if (( $SIZE > $MINSIZE + 5 )); then
            if (( $SIZE < $ROOTSIZE )); then
              echo "Detected suitable disk: $DEV ($SIZE GiB)"
              ROOTDEV=$DEV
              ROOTSIZE=$SIZE
            fi
          fi
        fi
      fi
    done

    cat <<EOF >/tmp/kiss-config
    # Write partition table
    part /boot/efi --fstype=efi --size=200 --ondisk=$ROOTDEV
    part /boot --fstype=ext4 --size=512 --ondisk=$ROOTDEV
    part / --fstype=ext4 --size=$(( $MINSIZE*2**10 )) --ondisk=$ROOTDEV

    # Configure the bootloader.
    bootloader --boot-drive $ROOTDEV
    EOF

    # Reboot after installation
    if $(nmcli device | grep '^[a-z0-9-]\+ *wifi \+' >/dev/null); then
    ## Wireless - WIFI => Power Off
    cat <<EOF >>/tmp/kiss-config
    poweroff
    EOF
    else
    ## Wired => Reboot
    cat <<EOF >>/tmp/kiss-config
    reboot
    EOF
    fi

    %end

    %post --erroronfail

    # Advanced Network configuration
    mkdir -p /etc/NetworkManager/system-connections/
    ## Wireless - WIFI
    if [ "NETWORK_WIRELESS_WIFI_SSID" != "" ]; then
    for interface in $(nmcli device | grep '^[a-z0-9-]\+ *wifi \+' | sed 's/^\([a-z0-9-]\+\).*$/\1/g' | xargs); do
    cat <<EOF >/etc/NetworkManager/system-connections/wireless-wifi-$interface-NETWORK_WIRELESS_WIFI_SSID
    [connection]
    id=wireless-wifi-$interface-NETWORK_WIRELESS_WIFI_SSID
    uuid=$(uuidgen $interface)
    type=wifi
    interface-name=$interface

    [wifi]
    mode=infrastructure
    ssid=NETWORK_WIRELESS_WIFI_SSID

    [wifi-security]
    auth-log=open
    key-mgmt=NETWORK_WIRELESS_WIFI_KEY_MGMT
    psk=NETWORK_WIRELESS_WIFI_KEY_PSK

    [ipv4]
    method=auto

    [ipv6]
    addr-gen-mode=default
    method=auto

    [proxy]
    EOF
    chmod 600 /etc/NetworkManager/system-connections/wireless-wifi-$interface-NETWORK_WIRELESS_WIFI_SSID
    done
    fi

    # Allow passwordless sudo command
    cat <<EOF >/etc/sudoers.d/10-wheel
    ENV_USERNAME ALL=(ALL) NOPASSWD: ALL
    EOF
    chmod 440 /etc/sudoers.d/10-wheel

    # ContainerD Configuration
    yum-config-manager --add-repo "https://download.docker.com/linux/centos/docker-ce.repo"
    dnf install -y containerd.io
    ln -sf /usr/lib/systemd/system/containerd.service /etc/systemd/system/multi-user.target.wants/containerd.service

    # Docker (Podman) Configuration
    mkdir -p /etc/containers/
    mkdir -p /etc/docker/
    mkdir -p /etc/systemd/system/docker.service.d/
    touch /etc/containers/nodocker
    cat <<EOF >/etc/docker/daemon.json
    {
      "insecure-registries": [
        "registry.kiss.svc.ops.netai-cloud"
      ]
    }
    EOF
    ln -sf /usr/lib/systemd/system/podman.socket /etc/systemd/system/sockets.target.wants/podman.socket

    # Environment Variables Configuration
    mkdir -p /etc/profile.d/
    cat <<EOF /etc/profile.d/path-local-bin.sh
    # local binary path registration

    export PATH=\${PATH}:/usr/local/bin
    export PATH=\${PATH}:/opt/bin
    EOF

    # Kernel Module Configuration
    mkdir -p /etc/modules-load.d/
    cat <<EOF >/etc/modules-load.d/10-gpu-nvidia-driver.conf
    loop
    i2c_core
    ipmi_msghandler
    EOF

    # KISS Configuration
    mkdir -p /etc/systemd/system/multi-user.target.wants/
    cat <<EOF >/etc/systemd/system/notify-new-box.service
    [Unit]
    Description=Notify to the kiss cluster that a new (this) box has been appeared.
    Wants=network-online.target
    After=network-online.target

    [Service]
    Type=oneshot
    Restart=on-failure
    ExecStart=/bin/bash -c " \
        ADDRESS=\$(ip -4 addr | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep '^10\.' | head -1) ;\
        UUID=\$(cat /sys/class/dmi/id/product_uuid) ;\
        curl --retry 5 --retry-delay 5 \"http://gateway.kiss.svc.ops.netai-cloud/new?address=\$ADDRESS&uuid=\$UUID\" ;\
    "
    Restart=on-failure
    RestartSec=30

    [Install]
    WantedBy=multi-user.target
    EOF
    ln -sf /etc/systemd/system/notify-new-box.service /etc/systemd/system/multi-user.target.wants/notify-new-box.service

    # Sysctl Configuration
    mkdir -p /etc/sysctl.d/
    cat <<EOF >/etc/sysctl.d/50-hugepages.conf
    vm.nr_hugepages=8192
    EOF
    cat <<EOF >/etc/sysctl.d/90-reverse-path-filter.conf
    net.ipv4.conf.all.rp_filter=0
    net.ipv4.conf.default.rp_filter=0
    EOF

    %end
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matchbox-groups
  namespace: kiss
data:
  default.json: |
    {
      "id": "default",
      "name": "default",
      "profile": "kiss",
      "selector": {},
      "metadata": {}
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matchbox-ignition
  namespace: kiss
data:
  kiss.yaml: |
    ---
    variant: flatcar
    version: 1.0.0
    kernel_arguments:
    passwd:
      users:
        - name: ENV_USERNAME
          ssh_authorized_keys:
            - ENV_SSH_AUTHORIZED_KEYS
          groups:
            - sudo
            - docker
    storage:
      directories:
        - path: /etc/systemd/system/docker.service.d
          filesystem: root
          overwrite: true
      files:
        - path: /etc/docker/daemon.json
          filesystem: root
          overwrite: true
          mode: 0444
          contents:
            inline: |
              {
                "insecure-registries": [
                  "registry.kiss.svc.ops.netai-cloud"
                ]
              }
        - path: /etc/modules-load.d/10-gpu-nvidia-driver.conf
          filesystem: root
          overwrite: true
          mode: 0444
          contents:
            inline: |
              loop
              i2c_core
              ipmi_msghandler
        - path: /etc/sysctl.d/50-hugepages.conf
          filesystem: root
          overwrite: true
          mode: 0444
          contents:
            inline: |
              vm.nr_hugepages=8192
        - path: /etc/sysctl.d/90-reverse-path-filter.conf
          filesystem: root
          overwrite: true
          mode: 0444
          contents:
            inline: |
              net.ipv4.conf.all.rp_filter=0
              net.ipv4.conf.default.rp_filter=0
        - path: /etc/systemd/system/notify-new-box.service
          filesystem: root
          overwrite: true
          mode: 0444
          contents:
            inline: |
              [Unit]
              Description=Notify to the kiss cluster that a new (this) box has been appeared.
              Wants=network-online.target
              After=network-online.target

              [Service]
              Type=oneshot
              Restart=on-failure
              ExecStart=/bin/bash -c " \
                  ADDRESS=$(ip -4 addr | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep '^10\.' | head -1) ;\
                  UUID=$(cat /sys/class/dmi/id/product_uuid) ;\
                  curl --retry 5 --retry-delay 5 \"http://gateway.kiss.svc.ops.netai-cloud/new?address=$ADDRESS&uuid=$UUID\" ;\
              "
              Restart=on-failure
              RestartSec=30

              [Install]
              WantedBy=multi-user.target
        - path: /etc/systemd/timesyncd.conf
          filesystem: root
          overwrite: true
          mode: 0444
          contents:
            inline: |
              [Time]
              #NTP=ntp.kiss.svc.ops.netai-cloud
        - path: /opt/bin/python
          filesystem: root
          overwrite: true
          mode: 0555
          contents:
            inline: |
              #!/usr/bin/bash
              # origin: https://github.com/kubernetes-sigs/kubespray/blob/release-2.19/roles/bootstrap-os/files/bootstrap.sh
              set -e

              ARCH=$(uname -m)
              BINDIR="/opt/bin"

              case $ARCH in
                "x86_64")
                  PYPY_ARCH=linux64
                  PYPI_HASH=46818cb3d74b96b34787548343d266e2562b531ddbaf330383ba930ff1930ed5
                  ;;
                "aarch64")
                  PYPY_ARCH=aarch64
                  PYPI_HASH=2e1ae193d98bc51439642a7618d521ea019f45b8fb226940f7e334c548d2b4b9
                  ;;
                *)
                  echo "Unsupported Architecture: ${ARCH}"
                  exit 1
              esac

              PYTHON_VERSION=3.9
              PYPY_VERSION=7.3.9
              PYPY_FILENAME="pypy${PYTHON_VERSION}-v${PYPY_VERSION}-${PYPY_ARCH}"
              PYPI_URL="https://downloads.python.org/pypy/${PYPY_FILENAME}.tar.bz2"

              # provision a python binary
              if [[ ! -e /opt/pypy3/bin/pypy3 ]]; then
                TAR_FILE="${BINDIR}/pyp.tar.bz2"
                sudo wget --tries=5 -O "${TAR_FILE}" "${PYPI_URL}"
                echo "${PYPI_HASH} ${TAR_FILE}" | sha256sum -c -
                sudo tar -xjf "${TAR_FILE}" && sudo rm "${TAR_FILE}"
                sudo mv -n "${PYPY_FILENAME}" "${BINDIR}/../pypy3"
              fi

              # execute python
              export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/pypy3/lib
              exec /opt/pypy3/bin/pypy3 "${@:1}"
        - path: /opt/bin/.bootstrapped
          filesystem: root
          mode: 0444
          contents:
            inline: ""
      links:
        - path: /etc/systemd/system/multi-user.target.wants/notify-new-box.service
          target: /etc/systemd/system/notify-new-box.service
          filesystem: root
          overwrite: true
          hard: false
    systemd:
      units:
        - name: docker.service
          enable: true
          dropins:
            - name: 30-increase-ulimit.conf
              contents: |
                [Service]
                LimitMEMLOCK=infinity
        - name: ntpd.service
          enable: false
        - name: systemd-timesyncd.service
          enable: true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matchbox-profiles
  namespace: kiss
data:
  kiss.json: |
    {
      "id": "kiss",
      "name": "NetAI Cloud KISS Linux (Flatcar Container Linux)",
      "boot": {
        "kernel": "http://assets.kiss.svc.ops.netai-cloud/flatcar-${buildarch}/current/flatcar_production_pxe.vmlinuz",
        "initrd": [
          "http://assets.kiss.svc.ops.netai-cloud/flatcar-${buildarch}/current/flatcar_production_pxe_image.cpio.gz"
        ],
        "args": [
          "initrd=flatcar_production_pxe_image.cpio.gz",
          "flatcar.config.url=http://matchbox.kiss.svc.ops.netai-cloud/ignition",
          "flatcar.first_boot=yes"
        ]
      },
      "ignition_id": "kiss.yaml"
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: matchbox
  namespace: kiss
  labels:
    name: matchbox
    kissService: "true"
    serviceType: internal
spec:
  replicas: 1
  strategy:
    rollingUpdate:
      maxUnavailable: 1
  selector:
    matchLabels:
      name: matchbox
  template:
    metadata:
      labels:
        name: matchbox
        kissService: "true"
        serviceType: internal
    spec:
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: init-data
          image: docker.io/ubuntu:rolling
          command:
            - bash
          args:
            - -c
            - |
              # Boot
              cp /var/lib/matchbox/assets/boot-raw/* /var/lib/matchbox/assets/boot/
              SSH_AUTHORIZED_KEYS_SED=$(sed -e 's/[&\\/]/\\&/g; s/$/\\/' -e '$s/\\$//' <<< ${SSH_AUTHORIZED_KEYS})
              sed -i "s/NETWORK_WIRELESS_WIFI_SSID/${NETWORK_WIRELESS_WIFI_SSID}/g" /var/lib/matchbox/assets/boot/*.ks
              sed -i "s/NETWORK_WIRELESS_WIFI_KEY_MGMT/${NETWORK_WIRELESS_WIFI_KEY_MGMT}/g" /var/lib/matchbox/assets/boot/*.ks
              sed -i "s/NETWORK_WIRELESS_WIFI_KEY_PSK/${NETWORK_WIRELESS_WIFI_KEY_PSK}/g" /var/lib/matchbox/assets/boot/*.ks
              sed -i "s/ENV_SSH_AUTHORIZED_KEYS/${SSH_AUTHORIZED_KEYS_SED}/g" /var/lib/matchbox/assets/boot/*.ks
              sed -i "s/ENV_USERNAME/${USERNAME}/g" /var/lib/matchbox/assets/boot/*.ks

              # Ignition
              cp /var/lib/matchbox/ignition-raw/*.yaml /var/lib/matchbox/ignition/
              SSH_AUTHORIZED_KEYS_SED=$(sed -e 's/[&\\/]/\\&/g; s/$/\\/' -e '$s/\\$//' <<< ${SSH_AUTHORIZED_KEYS})
              sed -i "s/ENV_SSH_AUTHORIZED_KEYS/${SSH_AUTHORIZED_KEYS_SED}/g" /var/lib/matchbox/ignition/*.yaml
              sed -i "s/ENV_USERNAME/${USERNAME}/g" /var/lib/matchbox/ignition/*.yaml
          env:
            - name: NETWORK_WIRELESS_WIFI_SSID
              valueFrom:
                secretKeyRef:
                  name: kiss-config
                  key: network_wireless_wifi_ssid
            - name: NETWORK_WIRELESS_WIFI_KEY_MGMT
              valueFrom:
                secretKeyRef:
                  name: kiss-config
                  key: network_wireless_wifi_key_mgmt
            - name: NETWORK_WIRELESS_WIFI_KEY_PSK
              valueFrom:
                secretKeyRef:
                  name: kiss-config
                  key: network_wireless_wifi_key_psk
            - name: SSH_AUTHORIZED_KEYS
              valueFrom:
                configMapKeyRef:
                  name: kiss-config
                  key: auth_ssh_key_id_ed25519_public
            - name: USERNAME
              valueFrom:
                configMapKeyRef:
                  name: kiss-config
                  key: auth_ssh_username
          resources:
            requests:
              cpu: 30m
              memory: 20Mi
            limits:
              cpu: 50m
              memory: 50Mi
          volumeMounts:
            - name: boot
              mountPath: /var/lib/matchbox/assets/boot
            - name: boot-raw
              mountPath: /var/lib/matchbox/assets/boot-raw
            - name: ignition
              mountPath: /var/lib/matchbox/ignition
            - name: ignition-raw
              mountPath: /var/lib/matchbox/ignition-raw
            - name: tmp
              mountPath: /tmp
      containers:
        - name: matchbox
          image: quay.io/poseidon/matchbox:v0.9.1-48-gddbed051
          env:
            - name: MATCHBOX_ADDRESS
              value: 0.0.0.0:8080
            - name: MATCHBOX_LOG_LEVEL
              value: debug
          ports:
            - name: http
              containerPort: 8080
          livenessProbe:
            initialDelaySeconds: 5
            httpGet:
              path: /
              port: 8080
          resources:
            requests:
              cpu: 30m
              memory: 20Mi
            limits:
              cpu: 50m
              memory: 50Mi
          volumeMounts:
            - name: assets
              mountPath: /var/lib/matchbox/assets
            - name: boot
              mountPath: /var/lib/matchbox/assets/boot
            - name: groups
              mountPath: /var/lib/matchbox/groups
            - name: ignition
              mountPath: /var/lib/matchbox/ignition
            - name: profiles
              mountPath: /var/lib/matchbox/profiles
      volumes:
        - name: assets
          emptyDir: {}
        - name: boot
          emptyDir: {}
        - name: boot-raw
          configMap:
            name: matchbox-boot
            defaultMode: 0400
        - name: groups
          configMap:
            name: matchbox-groups
            defaultMode: 0400
        - name: ignition
          emptyDir: {}
        - name: ignition-raw
          configMap:
            name: matchbox-ignition
            defaultMode: 0400
        - name: profiles
          configMap:
            name: matchbox-profiles
            defaultMode: 0400
        - name: tmp
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: matchbox
  namespace: kiss
spec:
  type: ClusterIP
  selector:
    name: matchbox
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 8080
