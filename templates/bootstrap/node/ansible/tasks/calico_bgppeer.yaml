---
# reference: https://github.com/kubernetes-sigs/kubespray/blob/master/roles/network_plugin/calico/tasks/peer_with_router.yml
- name: Calico | Configure peering with router(s) at global scope
  command:
    cmd: "{{ bin_dir }}/calicoctl.sh apply -f -"
    stdin: "{{ stdin is string | ternary(stdin, stdin|to_json) }}"
  vars:
    stdin: >
      {"apiVersion": "projectcalico.org/v3",
      "kind": "BGPPeer",
      "metadata": {
        "name": "global-{{ item.name | default(item.router_id|replace(':','-')) }}"
      },
      "spec": {
        "asNumber": "{{ item.as }}",
        "peerIP": "{{ item.router_id }}"
      }}
  register: output
  retries: 4
  until: output.rc == 0
  delay: "{{ 5 }}"
  with_items:
    - "{{ calico_bgp_peers | default([]) }}"
  when:
    - inventory_hostname == groups['kube_control_plane'][0]
