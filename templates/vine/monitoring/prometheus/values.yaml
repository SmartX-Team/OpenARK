---
## Affinity for pod assignment (evaluated as template)
## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity
##
affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      # KISS normal control plane nodes should be preferred
      - weight: 1
        preference:
          matchExpressions:
            - key: node-role.kubernetes.io/kiss-ephemeral-control-plane
              operator: DoesNotExist
      # KISS gateway nodes should be more preferred
      - weight: 2
        preference:
          matchExpressions:
            - key: node-role.kubernetes.io/kiss
              operator: In
              values:
                - Gateway
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: node-role.kubernetes.io/kiss
              operator: In
              values:
                - ControlPlane
                - Gateway

## Using default values from https://github.com/grafana/helm-charts/blob/main/charts/grafana/values.yaml
##
grafana:
  enabled: true

  ingress:
    ## If true, Grafana Ingress will be created
    ##
    enabled: true

    ## IngressClassName for Grafana Ingress.
    ## Should be provided if Ingress is enable.
    ##
    # ingressClassName: nginx

    ## Annotations for Grafana Ingress
    ##
    annotations:
      nginx.ingress.kubernetes.io/auth-url: http://$host/oauth2/auth
      nginx.ingress.kubernetes.io/auth-signin: http://$host/oauth2/start?rd=$escaped_request_uri
      nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
      nginx.ingress.kubernetes.io/rewrite-target: /$1
      vine.ulagbulag.io/is-service: "true"
      vine.ulagbulag.io/is-service-public: "true"
      vine.ulagbulag.io/is-service-system: "false"
      vine.ulagbulag.io/service-kind: Grafana

    ## Hostnames.
    ## Must be provided if Ingress is enable.
    ##
    # hosts:
    #   - grafana.domain.com

    ## Path for grafana ingress
    path: /dashboard/grafana/?(.*)

    # pathType is only for k8s >= 1.1=
    pathType: Prefix

    ## TLS configuration for grafana Ingress
    ## Secret must be manually created in the namespace
    ##
    # tls: []
    #   - secretName: grafana-general-tls
    #     hosts:
    #       - grafana.example.com

  ## Affinity for pod assignment (evaluated as template)
  ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity
  ##
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        # KISS normal control plane nodes should be preferred
        - weight: 1
          preference:
            matchExpressions:
              - key: node-role.kubernetes.io/kiss-ephemeral-control-plane
                operator: DoesNotExist
        # KISS gateway nodes should be more preferred
        - weight: 2
          preference:
            matchExpressions:
              - key: node-role.kubernetes.io/kiss
                operator: In
                values:
                  - Gateway
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node-role.kubernetes.io/kiss
                operator: In
                values:
                  - ControlPlane
                  - Gateway

  ## Configure grafana dashboard providers
  ## ref: http://docs.grafana.org/administration/provisioning/#dashboards
  ##
  ## `path` must be /var/lib/grafana/dashboards/<provider_name>
  ##
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: default
          orgId: 1
          folder: ""
          type: file
          disableDeletion: true
          editable: false
          options:
            path: /var/lib/grafana/dashboards/default

  ## Configure grafana dashboard to import
  ## NOTE: To use dashboards you must also enable/configure dashboardProviders
  ## ref: https://grafana.com/dashboards
  ##
  ## dashboards per provider, use provider name as key.
  ##
  dashboards:
    default:
      # GPU - NVIDIA
      nvidia-dcgm-exporter-dashboard:
        gnetId: 12239
        revision: 2
        datasource: Prometheus

  ## Grafana's primary configuration
  ## NOTE: values in map will be converted to ini format
  ## ref: http://docs.grafana.org/installation/configuration/
  ##
  grafana.ini:
    auth:
      # Disable usage of Grafana build-in login solution.
      # NOTE: it is needed to be 'false' to create a default grafana user
      disable_login: false

      # Set to true to disable (hide) the login form, useful if you use OAuth
      disable_login_form: true

      # Set to true to disable the sign out link in the side menu. Useful if you use auth.proxy or auth.jwt.
      disable_signout_menu: true

    # Anonymous Auth
    auth.anonymous:
      # enable anonymous access
      enabled: true

      # specify organization name that should be used for unauthenticated users
      # org_name: Ulagbulag Village - VINE

      # specify role for unauthenticated users
      # Available options: Admin, Editor, Viewer
      org_role: Viewer

    # Basic Auth
    auth.basic:
      # NOTE: it is needed to be 'true' to create a default grafana user
      enabled: true

    # grafana Authentication can be enabled with the following values on grafana.ini
    server:
      # The full public facing url you use in browser, used for redirects and emails
      root_url: null

## Deploy a Prometheus instance
##
prometheus:
  ## Settings affecting prometheusSpec
  ## ref: https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#prometheusspec
  ##
  prometheusSpec:
    ## If true, a nil or {} value for prometheus.prometheusSpec.serviceMonitorSelector will cause the
    ## prometheus resource to be created with selectors based on values in the helm deployment,
    ## which will also match the servicemonitors created
    ##
    serviceMonitorSelectorNilUsesHelmValues: false

    ## Assign custom affinity rules to the prometheus instance
    ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
    ##
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          # KISS normal control plane nodes should be preferred
          - weight: 1
            preference:
              matchExpressions:
                - key: node-role.kubernetes.io/kiss-ephemeral-control-plane
                  operator: DoesNotExist
          # KISS gateway nodes should be more preferred
          - weight: 2
            preference:
              matchExpressions:
                - key: node-role.kubernetes.io/kiss
                  operator: In
                  values:
                    - Gateway
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: node-role.kubernetes.io/kiss
                  operator: In
                  values:
                    - ControlPlane
                    - Gateway

    ## AdditionalScrapeConfigs allows specifying additional Prometheus scrape configurations. Scrape configurations
    ## are appended to the configurations generated by the Prometheus Operator. Job configurations must have the form
    ## as specified in the official Prometheus documentation:
    ## https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config. As scrape configs are
    ## appended, the user is responsible to make sure it is valid. Note that using this feature may expose the possibility
    ## to break upgrades of Prometheus. It is advised to review Prometheus release notes to ensure that no incompatible
    ## scrape configs are going to break Prometheus after the upgrade.
    ## AdditionalScrapeConfigs can be defined as a list or as a templated string.
    ##
    ## The scrape configuration example below will find master nodes, provided they have the name .*mst.*, relabel the
    ## port to 2379 and allow etcd scraping provided it is running on all Kubernetes master nodes
    ##
    additionalScrapeConfigs:
      - job_name: gpu-nvidia-metrics
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - gpu-nvidia
        scheme: http
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_node_name
            action: replace
            target_label: kubernetes_node
        scrape_interval: 1s
        metrics_path: /metrics

## Configuration for prometheus-node-exporter subchart
##
prometheus-node-exporter:
  ## Assign a group of affinity scheduling rules
  ##
  affinity:
    nodeAffinity:
      # KISS ephemeral control plane nodes should be excluded
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node-role.kubernetes.io/kiss-ephemeral-control-plane
                operator: DoesNotExist
